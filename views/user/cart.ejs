

<%- include('_userheader') %>

    <!-- Start Header Area -->
	<%- include('_headerNavBar') %>
	<!-- End Header Area -->

    <!-- Start Banner Area -->
    <section class="banner-area organic-breadcrumb">
        <div class="container">
            <div class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end">
                <div class="col-first">
                    <h1>Shopping Cart</h1>
                    <nav class="d-flex align-items-center">
                        <a href="/">Home<span class="lnr lnr-arrow-right"></span></a>
                        <a href="/cart">Cart</a>
                    </nav>
                </div>
            </div>
        </div>
    </section>
    <!-- End Banner Area -->

    <!--================Cart Area =================-->
    <section class="cart_area">
        <div class="container">
            <div class="cart_inner">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col"></th>
                                <th scope="col">Product</th>
                                <th scope="col">Brand</th>
                                
                                <th scope="col">Price</th>
                                <th scope="col">Quantity</th>
                                <th scope="col">Total</th>
                                <th scope="col">delete</th>

                            </tr>
                        </thead>
                        <tbody>
                            
                            
                            <% if (cart) { %>
                                <% let sum=0 %>

                                <% (cart.products).forEach(element => { %>
                              
                               
                                    <tr>
                                        <td><img src="<%= element.productId.image[0] %>" alt="" style="width: 100px;"></td>
                                        <td><%=element.name %> <br> <a data-toggle="modal" data-target="#editStatus<%=element._id     %>" >(Size: <b><%= element.size %></b> )</a> </td>
                                       
                                        
                                        <td><%=element.brand.name %></td>
                                       
                                        <td><%=element.price  %></td>
                                        <td>
                                            <div class="container  ">
                                                <div class="col ml-5 "  >
                                               
                                                <button onclick="dec('<%= element._id %>')" class=" col-md-2 mb-2 " style="border-width: 0px;">-</button>
                                                <span id="qty-<%=element._id%>"><%= element.quantity  %></span>
                                                <button onclick="inc('<%= element._id %>')" class=" col-md-2 mb-2 " style="border-width: 0px;" >+</button>
                                            </div>
                                           </div>    
                                        </td>
                                        
                                        <td id="total-<%= element._id %>"  class="item-total" ><%= element.price*element.quantity %></td>
                                        <td><a  href="/delete-cart/<%= element._id %>">
                                            <span class="text-gradient"><i style="color: orange;" class="fa fa-trash" aria-hidden="true"></i></span>
                                        </a></td>
                                       
                                      
                                      </form>
                                        
                                    </tr>
                                    
                                    <% }) %>
                             
                           
                            
                            <tr class="bottom_button">
                                <td>
                                    <!-- <a class="gray_btn" href="#">Update Cart</a> -->
                                </td>
                                <td>

                                </td>
                                <td>

                                </td>
                                <td>
                                    <!-- <div class="cupon_text d-flex align-items-center">
                                        <input type="text" placeholder="Coupon Code">
                                        <a class="primary-btn" href="#">Apply</a>
                                        <a class="gray_btn" href="#">Close Coupon</a>
                                    </div> -->
                                </td>
                            </tr>
                            <tr>


                                <td>

                                </td>
                                

                                <td>

                                </td>
                                <td>

                                </td>
                                <td>
                                    <h5>Subtotal</h5>
                                </td>
                                <td>
                                    <h5 id="subtotal" ><%= sum %></h5>
                                </td>
                            </tr>

                            <% } %>

                            <tr class="shipping_area">
                                <td>

                                </td>
                                <td>

                                </td>
                                <td>

                                </td>
                                <td>
                                    <h5>Shipping</h5>
                                </td>
                                <td>
                                    <div class="shipping_box">
                                        <ul class="list">
                                           
                                            
                                            
                                            <li class="active"><a href="#">Local Delivery: 00.00</a></li>
                                        </ul>
                                        <!-- <h6>Calculate Shipping <i class="fa fa-caret-down" aria-hidden="true"></i></h6>
                                        <select class="shipping_select">
                                            <option value="1">Bangladesh</option>
                                            <option value="2">India</option>
                                            <option value="4">Pakistan</option>
                                        </select>
                                        <select class="shipping_select">
                                            <option value="1">Select a State</option>
                                            <option value="2">Select a State</option>
                                            <option value="4">Select a State</option>
                                        </select>
                                        <input type="text" placeholder="Postcode/Zipcode">
                                        <a class="gray_btn" href="#">Update Details</a> -->
                                    </div>
                                </td>
                            </tr>
                            <tr class="out_button_area">
                               
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                
                                <td>
                                    <div class="checkout_btn_inner d-flex align-items-center ">
                                        <a  class="primary-btn" href="/loadingPage">Continue Shopping</a>
                                        
                                      <% if (cart) { %>
                                        <% if (cart.products[0]) { %>
                                            <a class="primary-btn ml-3" href="/address">Proceed to checkout</a>
                                          
                                             
                                           <% } %>
                                      <% } %>
                                    </div>
                                </td>
                                
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>
    <!--================End Cart Area =================-->



   <% if (cart) { %>
    <% cart.products.forEach(element => { %>
     <!-- Modal -->
     <div class="modal fade" id="editStatus<%=element._id%>" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLongTitle">Edit Size</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
             <form class="text-dark" action="/change-product-size/<%= element._id %>" method="post">
                   <div class="form-group">
                     <label for="name" class="col-form-label text-dark col-md-6">Size </label>
                     <select class="custom-select tm-select-accounts col-md-6" id="name" name="size">
                      <option value="7"<%=element.size=== 7 ? 'selected' : '' %>>7</option>
                      <option value="8" <%=element.size=== 8 ? 'selected' : '' %>>8</option>
					  <option value="9" <%=element.size=== 9 ? 'selected' : '' %>>9</option>
					  <option value="10" <%=element.size=== 10 ? 'selected' : '' %>>10</option>
					  <option value="11" <%=element.size=== 11 ? 'selected' : '' %>>11</option>
					  <option value="12" <%=element.size=== 12 ? 'selected' : '' %>>12</option>
                     </select>
                     
                   </div>
                   <div class="modal-footer">
                     <button type="button" class="btn btn-secondary" data-dismiss="modal">cancel</button>
                     <a><button type="submit" class="btn btn-primary">confirm</button></a>
                   </div>
                 </form>
            </div>
          </div>
        </div>
      </div>
        <% }) %>
   <% } %>



    <!-- start footer Area -->
    <%- include('_footerArea') %>
    <!-- End footer Area -->
    <!-- <script>
        
       

            async function inc(id,count,qty) {
                const field = document.getElementById('qty-'+id);
                const cartValue = field.value;
                const productId = field.getAttribute('product_id');
                
            try {
              const response = await fetch('/cart/inc', {method: 'POST',headers: {'Content-Type': 'application/json'},body: JSON.stringify({ cartValue, productId })});
              const data = await response.json();
              
              updateInputField(data,productId,count,qty);
            } catch (err) {
              console.error(err);
            }
                }
                
                

            async function dec(id,count,qty){
                const field = document.getElementById('qty-'+id);
                const cartValue = field.value;
                const productId = field.getAttribute('product_id');
                console.log(cartValue);
                   try {
                    const response = await fetch('/cart/dec',{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify({cartValue,productId})})
                    const data =  await response.json();
                    

                    updateInputField(data,productId,count,qty);
                    
                   } catch (err) {
                    console.error(err);
                    
                   }
                }
                function updateInputField(data,productId,count,qty){
                    function add(count,qty){quantity=parseInt(count)+parseInt(qty);console.log("this is from add",quantity);}
                    data.products.forEach(element => {
                        if(element._id=productId){console.log("this is data",element)}
                        
                        let sum=0;
                    document.getElementById('qty-'+productId).value=parseInt(qty)+count
                    document.getElementById("total-"+id).innerHTML=qty*price
                    document.getElementById('subtotal').innerHTML=sum+(qty*price)
                     });
                  
                         }

                         updateInputField(data,id)
              

                
               
                


    </script> -->


<script>
	const setSubtotal=()=>{
		const itemTotal=document.getElementsByClassName('item-total')
		let subtotal=0;
		for (let i = 0; i < itemTotal.length; i++) {

			subtotal+=Number(itemTotal[i].innerHTML)
		}
		document.getElementById('subtotal').innerHTML=subtotal;

	}
	setSubtotal();
	
	function inc(id){
		
		$.ajax({
			url:'/cart/inc',
			method:"post",
			data:{id:id},
			success:function(data){
				if(data.success){
					
					$(`#total-${id}`).text(data.total)
					
					$(`#qty-${id}`).text(data?.quantity)
					
					setSubtotal();
                    if(data.quantity==data.maxQuantity){
                    if(data.maxQuantity){
                        swal("Stock limit reached")
                    }

				}}
                else{
					console.log('error');
				}
			},
			error: function(jqXHR, textStatus, errorThrown){
				console.error(errorThrown);
			}
		})
	}

	function dec(id) {
	
	  var currentQuantity = parseInt($(`#qty-${id}`).text());
	  if (currentQuantity > 1) {
		$.ajax({
		url: "/cart/dec",
		method: "post",
		data: { id: id },
		success: function(data) {
		  // Handle success response here
		 
		  $(`#total-${id}`).text(data.total);
		  $(`#qty-${id}`).text(data?.quantity);
		  setSubtotal();
		  
		},
		error: function(jqXHR, textStatus, errorThrown) {
		  // Handle error response here
		  res.send('error')
		}
	  });
	  }else{
		$(`#qty-${id}`).text(1);
	}
	
	}
    </script>
    

   <%- include('_userfooter') %>


   